---
title: "Orkumál"
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: today
format: 
    html:
        code-fold: true
        toc: true
        toc-location: right
        toc-title: Efnisyfirlit
editor: source
theme: flatly
title-block-banner: true
standalone: true
self-contained: true
---


```{r}
#| include: false

library(cowplot)
library(tidyverse)
library(scales)
library(pxweb)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(geomtextpath)
library(ggtext)
library(here)
library(readxl)
library(janitor)
```

# Gögn

```{r}
d <- read_csv("https://raw.githubusercontent.com/owid/energy-data/master/owid-energy-data.csv") |> 
    select(country, year, 
           contains("gdp"), contains("pop"), 
           fossil_share_energy, fossil_share_elec, fossil_energy_per_capita,
           renewables_share_elec, renewables_share_energy, 
           energy_per_capita, per_capita_electricity,
           oil_prod_per_capita,
           greenhouse_gas_emissions,
           carbon_intensity_elec) |> 
    mutate(gdp_per_capita = gdp / population,
           greenhouse_per_capita = greenhouse_gas_emissions / population * 1e6 * 1e5,
           gdp_per_greenhouse = gdp / greenhouse_gas_emissions)
```

# Orka og framleiðsla

```{r}
start <- d |> filter(year >= 1980, energy_per_capita > 0) |> pull(energy_per_capita) |> min(na.rm = T)
end <- d |> filter(year >= 1980, energy_per_capita > 0) |> pull(energy_per_capita) |> max(na.rm = T)

min_gdp <- d |> filter(year >= 1980) |> pull(gdp_per_capita) |> min(na.rm = T)
max_gdp <- d |> filter(year >= 1980) |> pull(gdp_per_capita) |> max(na.rm = T)

plot_dat <- crossing(energy_per_capita = seq(log(start), log(end), length = 100) |> exp(),
                     ratio = c(0.25, 0.5, 1, 2, 4)) |> 
    mutate(gdp_per_capita = ratio * energy_per_capita) |> 
    filter(gdp_per_capita < max_gdp * 1.1,
           gdp_per_capita > min_gdp)

add_preds <- function(data, ...) {
    m <- lm(log(gdp_per_capita) ~ log(energy_per_capita), data = data)
    data$pred <- exp(predict(m))
    
    data
}


p <- d |> 
    select(gdp_per_capita, energy_per_capita, country, year) |> 
    drop_na() |> 
    filter(year >= 1980, country != "World") |> 
    group_by(country) |>
    filter(any(year == 1980)) |>
    ungroup() |> 
    group_by(year) |> 
    group_modify(add_preds) |> 
    ungroup() |> 
    ggplot(aes(energy_per_capita, gdp_per_capita,
               colour = (country == "Iceland"),
               size = (country == "Iceland"),
               alpha = (country == "Iceland"))) +
    geom_line(
        data = plot_dat,
        aes(energy_per_capita, gdp_per_capita, group = ratio),
        inherit.aes = FALSE
    ) +
    geom_text(data = plot_dat |> 
                  group_by(ratio) |> 
                  filter(energy_per_capita == max(energy_per_capita)) |> 
                  ungroup(),
              aes(x = energy_per_capita,
                  y = gdp_per_capita,
                  label = 1 / ratio),
              inherit.aes = FALSE, hjust = 0, vjust = 0, 
              nudge_x = 0.03,
              nudge_y = 0.03) +
    geom_line(aes(y = pred), lty = 2, col = "black", size = 1) +
    geom_point() +
    # geom_rangeframe() +
    scale_x_log10(labels = label_number(suffix = " kWh", big.mark = ".", decimal.mark = ",")) +
    scale_y_log10(labels = label_number(suffix = "$", big.mark = ".", decimal.mark = ",")) +
    scale_colour_manual(values = c("#969696", "#4292c6")) +
    scale_size_manual(values = c(2.5, 4)) +
    scale_alpha_manual(values = c(0.7, 1)) +
    theme_half_open(font_size = 12) +
    theme(legend.position = "none",
          plot.title = element_markdown(face = "plain")) +
    labs(x = "Orkuframleiðsla á mann",
         y = "Landsframleiðsla á mann",
         title = "Þróun orku- og landsframleiðslu á <b style='color:#4292c6'>Íslandi</b> samanborið við <b style='color:#969696'>heiminn</b>",
         subtitle = str_c("Heilar línur sýna mismunandi hlutföll orku- / landsframleiðslu",
                          "\n",
                          "Brotin lína sýnir fylgni stærðanna á heimsvísu",
                          "\n",
                          "Ár: {frame_time}"),
         caption = "Kóði og gögn: https://github.com/bgautijonsson/orkumal") +
    transition_time(as.integer(year)) +
    ease_aes("cubic-in-out")

p_vid <- animate(p, width = 12, height = 0.5 * 12, unit = "in", res = 150, fps = 25, duration = 15,
                 renderer = ffmpeg_renderer(format = "mp4"))

anim_save(filename = "throun_orku_framleidslu.mp4", animation = p_vid)
```

# Gróðurhúsalofttegundir og framleiðsla

```{r}
start <- d |> 
    filter(year >= 2000, greenhouse_per_capita > 0) |> 
    pull(greenhouse_per_capita) |>
    min(na.rm = T)
end <- d |>
    filter(year >= 2000, greenhouse_per_capita > 0) |> 
    pull(greenhouse_per_capita) |> 
    max(na.rm = T)

min_gdp <- d |> 
    filter(year >= 2000) |> 
    pull(gdp_per_capita) |> 
    min(na.rm = T)
max_gdp <- d |> 
    filter(year >= 2000) |> 
    pull(gdp_per_capita) |>
    max(na.rm = T)

plot_dat <- crossing(greenhouse_per_capita = seq(log(start),
                                                 log(end), 
                                                 length = 500) |> exp(),
                     ratio = c(1/16, 1/8, 1/4, 1/2, 1, 2, 4)) |> 
    mutate(gdp_per_capita = ratio * greenhouse_per_capita) |> 
    filter(gdp_per_capita <= max_gdp * 1.1,
           gdp_per_capita >= min_gdp)

add_preds <- function(data, ...) {
    m <- lm(log(gdp_per_capita) ~ log(greenhouse_per_capita), data = data)
    data$pred <- exp(predict(m))
    
    data
}


p <- d |> 
    select(gdp_per_capita, greenhouse_per_capita, country, year) |> 
    drop_na() |> 
    filter(year >= 2000, country != "World") |> 
    group_by(country) |>
    filter(any(year == 2000), all(greenhouse_per_capita > 0)) |>
    ungroup() |> 
    group_by(year) |> 
    group_modify(add_preds) |> 
    ungroup() |> 
    ggplot(aes(greenhouse_per_capita, gdp_per_capita,
               colour = (country == "Iceland"),
               size = (country == "Iceland"),
               alpha = (country == "Iceland"))) +
    geom_line(
        data = plot_dat,
        aes(greenhouse_per_capita, gdp_per_capita, group = ratio),
        inherit.aes = FALSE
    ) +
    geom_text(data = plot_dat |> 
                  group_by(ratio) |> 
                  filter(greenhouse_per_capita == max(greenhouse_per_capita)) |> 
                  ungroup(),
              aes(x = greenhouse_per_capita,
                  y = gdp_per_capita,
                  label = 1 / ratio),
              inherit.aes = FALSE, hjust = 0, vjust = 0, 
              nudge_x = 0.03,
              nudge_y = 0.03) +
    geom_line(aes(y = pred), lty = 2, col = "black", size = 1) +
    geom_point() +
    # geom_rangeframe() +
    scale_x_log10(labels = label_number(big.mark = ".", decimal.mark = ",")) +
    scale_y_log10(labels = label_number(suffix = "$", big.mark = ".", decimal.mark = ",")) +
    scale_colour_manual(values = c("#969696", "#4292c6")) +
    scale_size_manual(values = c(2.5, 4)) +
    scale_alpha_manual(values = c(0.7, 1)) +
    theme_half_open(font_size = 12) +
    theme(legend.position = "none",
          plot.title = element_markdown(face = "plain")) +
    labs(x = "Gróðurhúsalofttegundir (Milljörð tonna á 100.000 íbúa)",
         y = "Landsframleiðsla á mann",
         title = "Þróun útblásturs gróðurhúsalofttegunda og landsframleiðslu á <b style='color:#4292c6'>Íslandi</b> samanborið við <b style='color:#969696'>heiminn</b>",
         subtitle = str_c("Heilar línur sýna mismunandi hlutföll gróðushúsalofttegunda / landsframleiðslu",
                          "\n",
                          "Brotin lína sýnir fylgni stærðanna á heimsvísu",
                          "\n",
                          "Ár: {frame_time}"),
         caption = "Kóði og gögn: https://github.com/bgautijonsson/orkumal") +
    transition_time(as.integer(year)) +
    ease_aes("cubic-in-out")

p_vid <- animate(p, width = 12, height = 0.5 * 12, unit = "in", res = 150, fps = 25, duration = 10,
                 renderer = ffmpeg_renderer(format = "mp4"))

anim_save(filename = "throun_co2_framleidslu.mp4", animation = p_vid)
```

```{r}
# m <- lm(log(gdp_per_capita) ~ log(renewables_share_energy), data = d |> filter(year == 2018))
d |> 
    filter(year >= 1990) |> 
    select(year, country, gdp_per_capita, gdp_per_greenhouse, greenhouse_per_capita,
           carbon_intensity_elec) |> 
    drop_na() |> 
    group_by(country) |> 
    filter(all(greenhouse_per_capita > 0)) |> 
    ungroup() |> 
    # mutate(pred = predict(m) |> exp()) |> 
    ggplot(aes(greenhouse_per_capita * 1e12, gdp_per_capita,
               colour = (country == "Iceland"))) +
    geom_point() +
    geom_rangeframe() +
    scale_x_log10(labels = label_number(suffix = " kWh", big.mark = ".", decimal.mark = ",")) +
    scale_y_log10(labels = label_number(suffix = "$", big.mark = ".", decimal.mark = ",")) +
    scale_colour_manual(values = c("grey", "blue")) +
    theme_tufte() +
    theme(legend.position = "none") +
    transition_time(as.integer(year)) +
    ease_aes("cubic-in-out")
```
